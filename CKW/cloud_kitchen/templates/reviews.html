{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reviews | CKW Cloud Kitchen</title>
  <link rel="stylesheet" href="{% static 'reviews.css' %}" />
  <link href='https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <video autoplay muted loop class="background-video">
    <source src="{% static 'videos/BG2.mp4' %}" type="video/mp4">
  </video>
  <nav class="nav">
    <ul class="nav-content">
      <li class="nav-list">
        <a href="{% url 'home' %}" class="link-item">
          <i class='bx bxs-home link-icon'></i>
          <span class="link-text">Home</span>
        </a>
      </li>
      <li class="nav-list">
         <a href="{% url 'menu' %}" class="link-item">
           <i class='bx bxs-food-menu link-icon'></i>
           <span class="link-text">Menu</span>
         </a>
      </li>
      <li class="nav-list">
        <a href="{% url 'offers' %}" class="link-item">
          <i class='bx bxs-offer link-icon'></i>
          <span class="link-text">Offers</span>
        </a>
      </li>
      <li class="nav-list">
        <a href="{% url 'cart' %}" class="link-item">
          <i class='bx bxs-shopping-bag link-icon'></i>
          <span class="link-text">Cart</span>
        </a>
      </li>
      <li class="nav-list">
        <a href="{% url 'track' %}" class="link-item">
          <i class='bx bxs-truck link-icon'></i>
          <span class="link-text">Track</span>
        </a>
      </li>
      <li class="nav-list">
        <a href="{% url 'about' %}" class="link-item">
          <i class='bx bxs-info-circle link-icon'></i>
          <span class="link-text">About</span>
        </a>
      </li>
      <li class="nav-list">
        <a href="{% url 'contact' %}" class="link-item">
          <i class='bx bxs-phone link-icon'></i>
          <span class="link-text">Contact</span>
        </a>
      </li>
      <li class="nav-list">
        <a href="{% url 'reviews' %}" class="link-item active">
          <i class='bx bxs-star link-icon'></i>
          <span class="link-text">Reviews</span>
        </a>
      </li>
      <li class="nav-list">
        <a href="{% url 'profile' %}" class="link-item">
          <i class='bx bxs-user link-icon'></i>
          <span class="link-text">Profile</span>
        </a>
      </li>
    </ul>
  </nav>
  <div class="logout-container">
    <a href="{% url 'login' %}" class="logout-btn">Logout</a>
  </div>

  <!-- Reviews Container -->
  <div class="reviews-container">
    <!-- Page Title -->
    <div class="reviews-title">
      <h1>Customer Reviews</h1>
      <p>What our customers say about us</p>
    </div>

    <!-- Review Cards Grid -->
    {% if latest_reviews %}
    <div class="reviews-grid" id="reviewsGrid">
      {% for review in latest_reviews %}
      <div class="review-card" data-review-id="{{ review.id }}">
        <div class="review-header">
          <div class="user-info">
            <div class="user-avatar">
              {% if review.user.profile_pic %}
                <img src="{{ review.user.profile_pic.url }}" alt="{{ review.user.username }}">
              {% else %}
                <div class="default-avatar">{{ review.user.username|first|upper }}</div>
              {% endif %}
            </div>
            <div class="user-details">
              <h4>{{ review.user.username }}</h4>
              <div class="stars">
                {% for i in "12345" %}
                  <i class="fas fa-star {% if forloop.counter <= review.stars %}filled{% endif %}"></i>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        <div class="review-content">
          <p>{{ review.message }}</p>
          <div class="review-time">{{ review.created_at|date:"M d, Y h:i A" }}</div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="reviews-grid" id="reviewsGrid">
      <div class="no-reviews">
        <p>No reviews yet. Be the first to share your experience!</p>
      </div>
    </div>
    {% endif %}

    <!-- Submit Review Form -->
    <div class="submit-review-container">
      <h2>Share Your Experience</h2>
      <form id="reviewForm" class="review-form">
        {% csrf_token %}
        <div class="form-group">
          <label for="reviewMessage">Your Review</label>
          <textarea id="reviewMessage" name="message" placeholder="Tell us about your experience..." required maxlength="500"></textarea>
          <div class="char-count"><span id="charCount">0</span>/500</div>
        </div>

        <div class="form-group">
          <label>Rate Your Experience</label>
          <div class="star-rating">
            <input type="radio" id="star1" name="stars" value="1" required>
            <label for="star1" title="1 star"><i class="fas fa-star"></i></label>
            <input type="radio" id="star2" name="stars" value="2">
            <label for="star2" title="2 stars"><i class="fas fa-star"></i></label>
            <input type="radio" id="star3" name="stars" value="3">
            <label for="star3" title="3 stars"><i class="fas fa-star"></i></label>
            <input type="radio" id="star4" name="stars" value="4">
            <label for="star4" title="4 stars"><i class="fas fa-star"></i></label>
            <input type="radio" id="star5" name="stars" value="5">
            <label for="star5" title="5 stars"><i class="fas fa-star"></i></label>
          </div>
        </div>

        <button type="submit" class="submit-btn">
          <span class="btn-text">Submit Review</span>
          <i class="fas fa-paper-plane btn-icon"></i>
        </button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const linkItems = document.querySelectorAll('.link-item');

      linkItems.forEach(item => {
        item.addEventListener('click', function(e) {
          // Remove active class from all items
          linkItems.forEach(link => link.classList.remove('active'));
          // Add active class to clicked item
          this.classList.add('active');
        });
      });

      // Character counter for review message
      const reviewMessage = document.getElementById('reviewMessage');
      const charCount = document.getElementById('charCount');

      reviewMessage.addEventListener('input', function() {
        charCount.textContent = this.value.length;
      });

      // Star rating functionality
      const starInputs = document.querySelectorAll('.star-rating input');
      const starLabels = document.querySelectorAll('.star-rating label');

      starLabels.forEach((label, index) => {
        label.addEventListener('click', function() {
          const rating = index + 1;
          // Set the corresponding radio button as checked
          starInputs[index].checked = true;
          updateStarDisplay(rating);
        });

        label.addEventListener('mouseenter', function() {
          const rating = index + 1;
          highlightStars(rating);
        });

        label.addEventListener('mouseleave', function() {
          const checkedInput = document.querySelector('.star-rating input:checked');
          if (checkedInput) {
            updateStarDisplay(checkedInput.value);
          } else {
            clearStarHighlights();
          }
        });
      });

      function updateStarDisplay(rating) {
        starLabels.forEach((label, index) => {
          if (index < rating) {
            label.classList.add('selected');
          } else {
            label.classList.remove('selected');
          }
        });
      }

      function highlightStars(rating) {
        starLabels.forEach((label, index) => {
          if (index < rating) {
            label.classList.add('hovered');
          } else {
            label.classList.remove('hovered');
          }
        });
      }

      function clearStarHighlights() {
        starLabels.forEach(label => {
          label.classList.remove('hovered');
        });
      }

      // Submit review form
      const reviewForm = document.getElementById('reviewForm');
      reviewForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const message = formData.get('message').trim();
        const stars = formData.get('stars');

        if (!message) {
          alert('Please enter a review message.');
          return;
        }

        if (!stars) {
          alert('Please select a rating.');
          return;
        }

        try {
          const response = await fetch('/submit-review/', {
            method: 'POST',
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            alert(data.message);
            // Reset form
            reviewForm.reset();
            charCount.textContent = '0';
            document.querySelectorAll('.star-rating label').forEach(label => {
              label.classList.remove('selected', 'hovered');
            });
            // Refresh reviews
            loadLatestReviews();
          } else {
            alert('Error: ' + data.message);
          }
        } catch (error) {
          console.error('Error:', error);
          alert('An error occurred. Please try again.');
        }
      });

      // Load latest reviews
      async function loadLatestReviews() {
        try {
          const response = await fetch('/get-reviews/');
          const data = await response.json();

          if (data.success) {
            updateReviewsGrid(data.reviews);
          }
        } catch (error) {
          console.error('Error loading reviews:', error);
        }
      }

      function updateReviewsGrid(reviews) {
        const reviewsGrid = document.getElementById('reviewsGrid');

        if (reviews.length === 0) {
          reviewsGrid.innerHTML = '<div class="no-reviews"><p>No reviews yet. Be the first to share your experience!</p></div>';
          return;
        }

        reviewsGrid.innerHTML = reviews.map(review => `
          <div class="review-card" data-review-id="${review.id}">
            <div class="review-header">
              <div class="user-info">
                <div class="user-avatar">
                  ${review.profile_pic ?
                    `<img src="${review.profile_pic}" alt="${review.user}">` :
                    `<div class="default-avatar">${review.user.charAt(0).toUpperCase()}</div>`
                  }
                </div>
                <div class="user-details">
                  <h4>${review.user}</h4>
                  <div class="stars">
                    ${[1,2,3,4,5].map(i => `<i class="fas fa-star ${i <= review.stars ? 'filled' : ''}"></i>`).join('')}
                  </div>
                </div>
              </div>
            </div>
            <div class="review-content">
              <p>${review.message}</p>
              <div class="review-time">${formatDate(review.created_at)}</div>
            </div>
          </div>
        `).join('');
      }

      function formatDate(dateString) {
        const date = new Date(dateString + 'Z'); // Add Z to indicate UTC
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffMins < 1) {
          return 'Just now';
        } else if (diffMins < 60) {
          return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
        } else if (diffHours < 24) {
          return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        } else if (diffDays < 7) {
          return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        } else {
          const options = {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          };
          return date.toLocaleDateString('en-US', options);
        }
      }

      // Auto-refresh reviews every 30 seconds
      setInterval(loadLatestReviews, 30000);
    });
  </script>
</body>
</html>