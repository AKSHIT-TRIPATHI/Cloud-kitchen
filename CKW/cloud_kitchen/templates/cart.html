{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart | CKW Cloud Kitchen</title>
    <link rel="stylesheet" href="{% static 'cart.css' %}">
    <link href='https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://kit.fontawesome.com/95a02bd20d.js"></script>
</head>
<body>
    <video autoplay muted loop class="background-video">
        <source src="{% static 'videos/BG2.mp4' %}" type="video/mp4">
    </video>

    <!-- Navigation Bar -->
    <nav class="nav">
        <ul class="nav-content">
            <li class="nav-list">
                <a href="{% url 'home' %}" class="link-item">
                    <i class='bx bxs-home link-icon'></i>
                    <span class="link-text">Home</span>
                </a>
            </li>
            <li class="nav-list">
                <a href="{% url 'menu' %}" class="link-item">
                    <i class='bx bxs-food-menu link-icon'></i>
                    <span class="link-text">Menu</span>
                </a>
            </li>
            <li class="nav-list">
                <a href="{% url 'offers' %}" class="link-item">
                    <i class='bx bxs-offer link-icon'></i>
                    <span class="link-text">Offers</span>
                </a>
            </li>
            <li class="nav-list">
                <a href="#" class="link-item active">
                    <i class='bx bxs-shopping-bag link-icon'></i>
                    <span class="link-text">Cart</span>
                </a>
            </li>
            <li class="nav-list">
                <a href="{% url 'track' %}" class="link-item">
                    <i class='bx bxs-truck link-icon'></i>
                    <span class="link-text">Track</span>
                </a>
            </li>
            <li class="nav-list">
              <a href="{% url 'about' %}" class="link-item">
                <i class='bx bxs-info-circle link-icon'></i>
                <span class="link-text">About</span>
              </a>
            </li>
            <li class="nav-list">
              <a href="{% url 'contact' %}" class="link-item">
                <i class='bx bxs-phone link-icon'></i>
                <span class="link-text">Contact</span>
              </a>
            </li>
            <li class="nav-list">
                <a href="{% url 'reviews' %}" class="link-item">
                    <i class='bx bxs-star link-icon'></i>
                    <span class="link-text">Reviews</span>
                </a>
            </li>
            <li class="nav-list">
                <a href="{% url 'profile' %}" class="link-item">
                    <i class='bx bxs-user link-icon'></i>
                    <span class="link-text">Profile</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Logout Button -->
    <div class="logout-container">
        <a href="{% url 'login' %}" class="logout-btn">Logout</a>
    </div>

    <!-- CSRF Token -->
    {% csrf_token %}

    <!-- Cart Title -->
    <div class="cart-title">
        <h1>ðŸ›’ Your Shopping Cart</h1>
        <p>Review your delicious selections</p>
    </div>

    <!-- Cart Container -->
    <div class="cart-container">
        {% if cart_items %}
        <!-- Cart Items -->
        <div class="cart-items">
            {% for item in cart_items %}
            <div class="cart-item">
                <div class="item-image">
                    <i class="{{ item.icon_class }}"></i>
                </div>
                <div class="item-details">
                    <h3>{{ item.name }}</h3>
                    <p>{{ item.description|truncatechars:80 }}</p>
                    <div class="item-price">â‚¹{{ item.price }}</div>
                </div>
                <div class="quantity-controls">
                    <button class="qty-btn" onclick="updateQuantity('{{ item.id }}', 'decrease')">-</button>
                    <span class="quantity">{{ item.quantity }}</span>
                    <button class="qty-btn" onclick="updateQuantity('{{ item.id }}', 'increase')">+</button>
                </div>
                <div class="item-total">â‚¹{{ item.total_price }}</div>
                <button class="remove-btn" onclick="removeItem('{{ item.id }}')">
                    <i class='bx bx-trash'></i>
                </button>
            </div>
            {% endfor %}
        </div>

        <!-- Cart Summary -->
        <div class="cart-summary">
            <h3>Order Summary</h3>
            <div class="summary-row">
                <span>Subtotal:</span>
                <span>â‚¹{{ subtotal }}</span>
            </div>
            <div class="summary-row">
                <span>Delivery Fee:</span>
                <span>â‚¹{{ delivery_fee }}</span>
            </div>
            <div class="summary-row">
                <span>Tax:</span>
                <span>â‚¹{{ tax }}</span>
            </div>
            <div class="summary-row total-row">
                <span><strong>Total:</strong></span>
                <span><strong>â‚¹{{ total }}</strong></span>
            </div>
            <button class="checkout-btn" onclick="proceedToPay()">
                Pay â‚¹{{ total }}
            </button>
            <button class="continue-shopping-btn" onclick="continueShopping()">
                Continue Shopping
            </button>
        </div>
        {% else %}
        <!-- Empty Cart -->
        <div class="empty-cart">
            <div class="empty-cart-content">
                <h2>Your cart is empty! ðŸ›’</h2>
                <p>Add some delicious items from our menu</p>
                <a href="{% url 'menu' %}" class="view-all-menu-btn">Browse Full Menu</a>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const linkItems = document.querySelectorAll('.link-item');

            linkItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    // Remove active class from all items
                    linkItems.forEach(link => link.classList.remove('active'));
                    // Add active class to clicked item
                    this.classList.add('active');
                });
            });
        });

        async function updateQuantity(cartItemId, action) {
            try {
                const response = await fetch(`/update-cart-item/${cartItemId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    },
                    body: `action=${action}`
                });

                const data = await response.json();

                if (data.success) {
                    // Update the UI with new data
                    location.reload(); // Simple reload for now, could be optimized with DOM updates
                } else {
                    alert('Error updating quantity: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while updating quantity. Please try again.');
            }
        }

        async function removeItem(cartItemId) {
            if (confirm('Are you sure you want to remove this item from your cart?')) {
                try {
                    const response = await fetch(`/remove-from-cart/${cartItemId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        location.reload(); // Reload to update totals
                    } else {
                        alert('Error removing item: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error removing item');
                }
            }
        }

        async function proceedToPay() {
            try {
                const response = await fetch("{% url 'order_confirmation' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Redirect to order confirmation page
                    window.location.href = "{% url 'order_confirmation' %}";
                } else {
                    alert('Error creating order. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating order. Please try again.');
            }
        }

        function continueShopping() {
            // Redirect to menu page
            window.location.href = "{% url 'menu' %}";
        }
    </script>
</body>
</html>
